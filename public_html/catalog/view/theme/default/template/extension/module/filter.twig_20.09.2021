<div class="panel panel-default filter-module">
  <div class="list-group"> {% for filter_group in filter_groups %} <a class="list-group-item"><span>{{ filter_group.name }}</span><i class="fa fa-caret-down toggle-icon"></i></a>
    <div class="list-group-item kai-hidden-filter-category-item">
      <div id="filter-group{{ filter_group.filter_group_id }}">{% for filter in filter_group.filter %}
        <div class="checkbox">
          <label>{% if filter.filter_id in filter_category %}
            <input type="checkbox" name="filter[]" value="{{ filter.filter_id }}" checked="checked" />
            {{ filter.name }}
            {% else %}
            <input type="checkbox" name="filter[]" value="{{ filter.filter_id }}" />
            {{ filter.name }}
            {% endif %}</label>
        </div>
        {% endfor %}</div>
    </div>
    {% endfor %}</div>
  
</div>
<script type="text/javascript">

function appendToDiv(div, data, page ) { 
      let html = '';
      for( let ind in data ){
        let product = data[ind];
        
        html += '<div class="product-layout product-grid product-grid-3 col-lg-4 col-md-4 col-sm-6 col-xs-12" data-page="'+ page +'">';
        html += '<div class="product-item-container">';   
        html += '<div class="left-block left-b">';
        html += '<div class="product-image-container">';
        html += '<a href="' + product.href + '" title="' + product.name + '">';
        html += '<img  data-sizes="auto" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="' + product.thumb + '"  title="' + product.name + '" class="lazyload img-responsive" />';
        html += '</a>';
        html += '</div>';
        html += '</div>';       
        html += '<div class="right-block right-b">';
        html += '<h4><a href="' + product.href + '" target="_blank">' + product.name + '</a></h4>';
        if ( product.price ){ 
          html += '<div class="price">';
          if ( !product.special ) {
            html += '<span class="price-new">' + product.price + '</span>';
          }else {   
            html += '<span class="price-new">' + product.special + '</span> <span class="price-old">' + product.price + '</span>';
          } 
          html += '</div>';
        }         
        html += '<div class="description">';
        html += '<p>' + product.description + '</p>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
        html += '</div>';
      }
        
       div.append( html )
    }


$('.filter-module input[type=checkbox]').on('change', function(e) {  

var id = $(this).val(), man = {{ man }}, parent = {{ parent }};

if( $(this).prop('checked') ){ 
  $.ajax({
    url: 'index.php?route=product/category/getFilterData',
      type: 'get',
      data: 'filter_id=' + id,
      dataType: 'json',
      success:function( response ){
      //display selected filter info
        $('.kai-selected-filters').append('<p class="kai-f-selected" data-f="'+id+'">'+response.filter_data.name + ' - ' + response.filter_data.filter_name+'<a href="/"><i class="fa fa-close"></i></a></p>')
      }
  });
} else {//remove selected filter info

  $('.kai-f-selected[data-f='+ id + ']').remove()
}      

var filter = [],
    sortOrder = $('#input-sort').val(), sortOrderArr, sort, order, minPrice, maxPrice;
    
    sortOrderArr = sortOrder.split('-');
    sort = sortOrderArr[0];
    order = sortOrderArr[1];
    minPrice = $("#min-price").val();
    maxPrice = $('#max-price').val();

	  $('input[name^=\'filter\']:checked').each(function(element) {
	 	  filter.push(this.value);
	  });
    //filter the profucts
    $.ajax({
      url: 'index.php?route=product/category/load_products',
      type: 'get',
      data: 'path={{ path }}&page=1&limit=12&filter=' + filter.join(',') + "&sort=" + sort + "&order="+order + "&min_pr="+minPrice+"&max_pr="+maxPrice+ '&man=' + man + '&parent='+parent,
      dataType: 'json',
      success:function( response ){ 
        console.log( response.total, 'filter select/deselct')
        $('#total-products').val(response.total)
        let html = '', data = response.products, page = 1, f = response.filters;        
        //attach filtered products
        for( let ind in data ){          
          let product = data[ind];
        
          html += '<div class="product-layout product-grid product-grid-3 col-lg-4 col-md-4 col-sm-6 col-xs-12" data-page="'+ page +'">';
          html += '<div class="product-item-container">';   
          html += '<div class="left-block left-b">';
          html += '<div class="product-image-container">';
          html += '<a href="' + product.href + '" title="' + product.name + '">';
          html += '<img  data-sizes="auto" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" data-src="' + product.thumb + '"  title="' + product.name + '" class="lazyload img-responsive" />';
          html += '</a>';
          html += '</div>';
          html += '</div>';       
          html += '<div class="right-block right-b">';
          html += '<h4><a href="' + product.href + '" target="_blank">' + product.name + '</a></h4>';
          if ( product.price ){ 
          html += '<div class="price">';
            if ( !product.special ) {
              html += '<span class="price-new">' + product.price + '</span>';
            }else {   
              html += '<span class="price-new">' + product.special + '</span> <span class="price-old">' + product.price + '</span>';
            } 
          html += '</div>';
          }         
          html += '<div class="description">';
          html += '<p>' + product.description + '</p>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
          html += '</div>';
        }
        
        $('.products-list').html( html )

        $('.checkbox').addClass('hidden-kai-filter');
        $('.filter-module .list-group a').addClass('hidden-kai-filter-group');
        for( let ind in f ){
          let currentF = f[ind];
          for( let i in currentF ){
            $('input[value='+currentF[i]+']').parents('.checkbox').removeClass('hidden-kai-filter');
            $('input[value='+currentF[i]+']').parents('.list-group-item').prev().removeClass('hidden-kai-filter-group')
          }
        }
      }
    });
  });

  $(".filter-module a.list-group-item").on('click', function(e){       
       let filterItems = $(this).next();
    //   console.log( $(this).find('.fa'))
        if( filterItems.hasClass('kai-hidden-filter-category-item') ){
            filterItems.removeClass('kai-hidden-filter-category-item').css({
                borderStyle:'solid',
                borderWidth: '1px',
                borderColor: '#ccc',
                borderLeft: 'none',
                borderRight: 'none',
                borderBottom: 'none'
            })
           
            $(this).find('span').css({
                borderStyle:'solid',
                borderWidth: '3px',
                borderColor: ' #E30025',
                borderLeft: 'none',
                borderTop: 'none',
                borderRight: 'none'
            })
            
       console.log( $(this).find('.fa'))
            $(this).find('i').removeClass('fa-caret-down').addClass('fa-caret-up');
        } else {
            filterItems.addClass('kai-hidden-filter-category-item').css('border-top', 'none')
            $(this).find('span').css('border-bottom', 'none');
            
       console.log( $(this).find('.fa'))
            $(this).find('i').removeClass('fa-caret-up').addClass('fa-caret-down');
        }
  })    
</script> 
