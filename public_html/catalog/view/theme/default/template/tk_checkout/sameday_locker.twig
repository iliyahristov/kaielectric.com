<div id="tk_sameday_locker">
	<div class="tk_panel">
		<div class="tk_panel_heading">
			<span class="tk_panel_icon"><span class="tk_icon-address"></span></span>
			<span class="tk_panel_text"> {{ text_locker_title }}</span>
			<span class="tk_all_spin"><i class="tk_icon-spin rotating"></i></span>
			
			<div id="tk_sameday_map" class="tk_right" {% if (customer_type is defined and customer_type == 'new') %} style="display:inline-block" {% else %}style="display:none"{% endif %}>
				<span class="tk_panel_text"> <a href="javascript:void(0);" id="sameday_locator" style="color:red;">{{ text_locker_map }}</a></span>
			</div>
		</div>
		
		<div class="tk_panel_body">
			
			<div id="tk_sameday_lockers">
				
				<input type="hidden" id="shipping_to" name="shipping_to" value="locker"/>
				<input type="hidden" id="shipping_type" name="shipping_type" value="sameday"/>
				<input type="hidden" id="service" name="service" value="{{ service }}"/>
				<input type="hidden" id="country_iso" name="country_iso" value="{{ country_iso }}"/>
				<input type="hidden" id="sameday_locker_postcode" name="locker_postcode" value="{{ locker_postcode }}"/>
				<input type="hidden" id="sameday_locker_county_id" name="locker_county_id" value="{{ locker_county_id }}">
				<input type="hidden" id="sameday_locker_county" name="locker_county" value="{{ locker_county }}"/>
				<input type="hidden" id="sameday_locker_city_id" name="locker_city_id" value="{{ locker_city_id }}"/>
				<input type="hidden" id="sameday_locker_city" name="locker_city" value="{{ locker_city }}"/>
				<input type="hidden" id="sameday_locker_id" name="locker_id" value="{{ locker_id }}">
				<input type="hidden" id="sameday_locker_name" name="locker_name" value="{{ locker_name }}"/>
				<input type="hidden" id="sameday_locker_address" name="locker_address" value="{{ locker_address }}">
				
				{% if module_tk_checkout_zone is not defined or module_tk_checkout_zone == 0 %}
					<input type="hidden" id="zone_id" name="zone_id" value="{{ zone_id }}"/>
				{% endif %}
				
				
				{% if (customer_lockers) %}
					<div class="tk_12_column tk_center_column">
						<label>
							<input type="radio" name="customer_type" value="existing" checked="checked" {% if (customer_type is defined and customer_type == 'existing') %}checked=""{% endif %} onclick="jQuery('#locker_new').hide();jQuery('#locker_existing').show();"/>
							{{ text_address_existing }}
						</label>
					</div>
					<div id="locker_existing">
						<div class="tk_12_column tk_center_column">
							<select name="sameday_customer_id">
								{% for customer_locker in customer_lockers %}
									
									<option value="{{ customer_locker['sameday_customer_id'] }}" {% if (sameday_customer_id is defined and customer_locker['sameday_customer_id'] == sameday_customer_id) %}selected="selected"{% endif %}>{{ customer_locker['locker_city'] }} {{ customer_locker['locker_name'] }}</option>
								
								{% endfor %}
							</select>
						</div>
					</div>
					<div class="tk_12_column tk_center_column">
						<label>
							<input type="radio" name="customer_type" value="new" {% if (customer_type is defined and customer_type == 'new') %}checked=""{% endif %} onclick="jQuery('#sameday_locker_new').show();jQuery('#tk_sameday_locker_existing').hide();jQuery('#tk_sameday_map').show();"/>
							{{ text_address_new }}
						</label>
					</div>
				
				{% else %}
					<input type="hidden" name="customer_type" value="new">
				{% endif %}
				
				<div id="locker_new" {% if (not customer_lockers or (customer_type is defined and customer_type == 'new')) %} style="display:block" {% else %}style="display:none"{% endif %}>
					
					<div class="tk_6_column tk_center_column tk_required_box {% if (locker_county) %} tk_redy_box{% endif %}" id="box_sameday_locker_county_select">
						<input type="text" id="sameday_locker_county_select" readonly="true" name="sameday_locker_county_select" value="{{ locker_county }}" placeholder="{{ text_county }}"/>
						<span class="tk_floating_label">{{ text_county }}</span>
					</div>
					
					<div class="tk_6_column tk_center_column tk_required_box {% if (locker_city) %} tk_redy_box{% endif %}" id="box_sameday_locker_city_select">
						<input type="text" id="sameday_locker_city_select" readonly="true" name="sameday_locker_city_select" value="{{ locker_city }}" placeholder="{{ text_city }}" {% if (not locker_county_id) %}disabled=""{% endif %}/>
						<span class="tk_floating_label">{{ text_city }}</span>
					</div>
					
					<div class="tk_clear"></div>
					
					<div class="tk_12_column tk_center_column tk_required_box {% if (((sameday_lockers|length) < 1 or locker_id and locker_id > 0) and locker_city_id) %} tk_redy_box{% endif %}" id="box_sameday_locker_select">
						<input type="text" id="sameday_locker_select" readonly="true" name="sameday_locker_select" value="{% if (locker_id) %}{{ locker_name }}{% endif %}" placeholder="{{ text_locker }}" {% if (not locker_city_id) %}disabled=""{% endif %} />
						<span class="tk_floating_label">{{ text_locker }}</span>
					</div>
					
					<div class="tk_clear"></div>
				
				</div>
				<div class="tk_clear"></div>
			</div>
		</div>
	</div>
</div>

<div class="radio_container mfp-hide" id="sameday_locker_county_locator">
	<div class="radio_search">
		<input id="sameday_locker_county_search" name="sameday_locker_county_search" type="text" placeholder="{{ text_search }}.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for sameday_locker_county in sameday_counties %}
			<div class="radio_elements">
				<label>
					<input type="radio" name="sameday_locator_locker_county_id" value="{{ sameday_locker_county['locker_county_id'] }}" {% if (locker_county_id is defined and sameday_locker_county['locker_county_id'] == locker_county_id) %}checked=""{% endif %} data-name="{{ sameday_locker_county['locker_county'] }}">{{ sameday_locker_county['locker_county'] }}
				</label>
			</div>
		{% endfor %}
	</div>
</div>

<div class="radio_container mfp-hide" id="sameday_locker_city_locator">
	<div class="radio_search">
		<input id="sameday_locker_city_search" name="sameday_locker_city_search" type="text" placeholder="Търсене.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for sameday_locker_city in sameday_cities %}
			<div class="radio_elements">
				<label>
					<input type="radio" name="sameday_locator_locker_city_id" value="{{ sameday_locker_city['locker_city_id'] }}" {% if (locker_city_id is defined and sameday_locker_city['locker_city_id'] == locker_city_id) %}checked=""{% endif %} data-name="{{ sameday_locker_city['locker_city'] }}" data-locker_postcode="{{ sameday_locker_city['locker_postcode'] }}">{{ sameday_locker_city['locker_city'] }}
				</label>
			</div>
		{% endfor %}
	</div>
</div>

<div class="radio_container mfp-hide" id="sameday_locker_locator">
	<div class="radio_search">
		<input id="sameday_locker_search" name="sameday_locker_search" type="text" placeholder="Търсене.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for locker in sameday_lockers %}
			<div class="radio_elements">
				<label>
					<input type="radio" name="sameday_locator_locker_id" value="{{ locker['locker_id'] }}" {% if (locker_id is defined and locker['locker_id'] == locker_id) %}checked=""{% endif %} data-name="{{ locker['locker_name'] }}" data-address="{{ locker['locker_address'] }}">
					<span>{{ locker['locker_id'] }}</span> <strong>{{ locker['locker_name'] }}</strong> <br>
					<i>{{ locker['locker_address'] }}</i> </label>
			</div>
		{% endfor %}
	</div>
</div>

<script src="https://cdn.sameday.ro/locker-plugin/lockerpluginsdk.js"></script>
<script>
		//селектор от картата
    $(document).ready(function () {
        getPaymentMethod();

        const samedayDayVal = '{{ service }}' + ".";
        const hostCountry = '{{ country_iso }}';
        const apiUsername = '{{ shipping_tk_sameday_username }}';
        $(document).on("click", "#sameday_locator", function () {
            const clientId = "b8cb2ee3-41b9-4c3d-aafe-1527b453d65e";
            const lockerInit = {
                'clientId': clientId,
                'countryCode': hostCountry,
                'langCode': hostCountry.toLowerCase(),
                'apiUsername': apiUsername,
            };

            window.LockerPlugin.init(lockerInit);

            let plugin = window.LockerPlugin.getInstance();

            plugin.open();

            plugin.subscribe((message) => {
                let locker = `${message.lockerId}.${message.name}`;
                let lockerValue = message.lockerId;
								console.log(message);
                $("#sameday_locker_county_select").val(message.county);
                $("#sameday_locker_city_select").val(message.city);
		            $("#sameday_locker_select").val(message.name);
        
                $("#sameday_locker_city_select").prop('disabled', false);
                $("#sameday_locker_select").prop('disabled', false);
                
                $("#sameday_locker_county").val(message.county);
                $("#sameday_locker_county_id").val(message.countyId);
                $("#sameday_locker_city").val(message.city);
                $("#sameday_locker_city_id").val(message.cityId);
                $('#sameday_locker_postcode').val(message.postalCode);
                $("#sameday_locker_id").val(message.lockerId);
                $("#sameday_locker_name").val(message.name);
                $("#sameday_locker_address").val(message.address);
                
                $('#box_sameday_locker_county_select').addClass('tk_redy_box');
                $('#box_sameday_locker_city_select').addClass('tk_redy_box');
                $('#box_sameday_locker_select').addClass('tk_redy_box');
		            
                getLockersCities();
                getLockers();
                saveData();

                $('#tk_button_confirm').button('reset');
                $('.tk_all_spin').html('');
                $('#tk_checkout').css('opacity', '1');
                $('#tk_checkout').css('pointer-events', 'auto');

                plugin.close();
            });
        });
    });

    //попъп за области
    $(document).on('click', '#box_sameday_locker_county_select', function (e) {
        e.stopImmediatePropagation();

        $.magnificPopup.open({
            type: 'inline',
            items: {src: '#sameday_locker_county_locator'}
        });

        setTimeout(function () {
            $('#sameday_locker_county_search').focus();
        }, 200);
    });

    //въвеждане на област ръчно
    $("#sameday_locker_county_search").on("keyup", function (e) {
        e.stopImmediatePropagation();

        var value = $(this).val().toLowerCase();
        var bg_value = transliterate(value);
        var en_value = transliterateEN(value);

        $("#sameday_locker_county_locator .radio_box .radio_elements").filter(function () {
            $(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
        });
    });

    //добавяне на селектирана област и извеждаме градове спрямо нея
    $(document).delegate('#sameday_locker_county_locator .radio_box input[type=\'radio\']', 'click', function (e) {
        e.stopImmediatePropagation();

        $('#sameday_locker_county_id').val($(this).val());
        $('#sameday_locker_county').val($(this).data('name'));
        $('#sameday_locker_county_select').val($(this).data('name'));

        $('#sameday_locker_city_id').val('');
        $('#sameday_locker_city').val('');
        $('#sameday_locker_city_select').val('');
        $('#sameday_locker_city_locator .radio_box').html('');
        $("#sameday_locker_city_select").prop('disabled', false);
		    
        $('#box_sameday_locker_city_select').removeClass('tk_redy_box');

        $('#sameday_locker_id').val('');
        $('#sameday_locker_name').val('');
        $('#sameday_locker_address').val('');
        $('#sameday_locker_locator .radio_box').html('');
        $('#sameday_locker_select').val('');
        $("#sameday_locker_select").prop('disabled', true);
		    
        $('#box_sameday_locker_select').removeClass('tk_redy_box');

        getLockersCities();
       
        $.magnificPopup.close();
    });

    //попъп за градове
    $(document).on('click', '#box_sameday_locker_city_select', function (e) {
        e.stopImmediatePropagation();

        $.magnificPopup.open({
            type: 'inline',
            items: {src: '#sameday_locker_city_locator'}
        });

        setTimeout(function () {
            $('#sameday_locker_city_search').focus();
        }, 200);
    });

    //въвеждане на град ръчно
    $("#sameday_locker_city_search").on("keyup", function (e) {
        e.stopImmediatePropagation();

        var value = $(this).val().toLowerCase();
        var bg_value = transliterate(value);
        var en_value = transliterateEN(value);

        $("#sameday_locker_city_locator .radio_box .radio_elements").filter(function () {
            $(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
        });
    });

    //добавяне на селектирания град и извеждаме офисите спрямо него
    $(document).delegate('#sameday_locker_city_locator .radio_box input[type=\'radio\']', 'click', function (e) {
        e.stopImmediatePropagation();

        $('#sameday_locker_postcode').val($(this).data('locker_postcode'));
		    
        $('#sameday_locker_city_id').val($(this).val());
        $('#sameday_locker_city').val($(this).data('name'));
        $('#sameday_locker_city_select').val($(this).data('name'));
        $("#sameday_locker_city_select").prop('disabled', false);
		    
        $('#box_sameday_locker_city_select').addClass('tk_redy_box');
		    
        $('#sameday_locker_id').val('');
        $('#sameday_locker_name').val('');
        $('#sameday_locker_address').val('');
        $('#sameday_locker_locator .radio_box').html('');
        $('#sameday_locker_select').val('');
        $("#sameday_locker_select").prop('disabled', false);

        $('#box_sameday_locker_select').removeClass('tk_redy_box');

        getLockers();

        $.magnificPopup.close()

    });

    //попъп за офиси
    $(document).on('click', '#sameday_locker_select', function (e) {
        e.stopImmediatePropagation();
        $.magnificPopup.open({
            type: 'inline',
            items: {src: '#sameday_locker_locator'}
        });
        setTimeout(function () {
            $('#sameday_locker_search').focus();
        }, 500);
    });

    //въвеждане на офис ръчно
    $("#sameday_locker_search").on("keyup", function (e) {
        e.stopImmediatePropagation();
        
		    var value = $(this).val().toLowerCase();
        var bg_value = transliterate(value);
        var en_value = transliterateEN(value);
		    
        $("#sameday_locker_locator .radio_box .radio_elements").filter(function () {
            $(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
        });
    });

    //добавяне на селектирания офис и извеждаме данните за него
    $(document).delegate('#sameday_locker_locator .radio_box input[type=\'radio\']', 'click', function (e) {
        e.stopImmediatePropagation();

        $('#sameday_locker_id').val($(this).val());
        $('#sameday_locker_name').val($(this).data('name'));
        $('#sameday_locker_address').val($(this).data('address'));
        $('#sameday_locker_select').val($(this).data('name'));
		    
        $('#box_sameday_locker_select').addClass('tk_redy_box');
        
        saveData();

        $('#tk_button_confirm').button('reset');
        $('.tk_all_spin').html('');
        $('#tk_checkout').css('opacity', '1');
        $('#tk_checkout').css('pointer-events', 'auto');

        $.magnificPopup.close()
    });

    //извиква данните за градове
    function getLockersCities() {
        var url = 'index.php?route=extension/shipping/tk_sameday/getLockersCities';

        var country_iso = $('#country_iso').val();
        url += '&country_iso=' + encodeURIComponent(country_iso);

        var locker_county_id = $('#sameday_locker_county_id').val();
        url += '&locker_county_id=' + encodeURIComponent(locker_county_id);

        $.ajax({
            url: url,
            type: 'GET',
            dataType: 'json',
            beforeSend: function () {
                $('.locker_city_spin').html(' <i class="tk_icon-spin rotating"></i>');
            },
            success: function (data) {
                $('.locker_city_spin').html('');
                
                $('#sameday_locker_city_locator .radio_box').html('{{ text_no_cities }}');

                html = '';

                if (data.cities_count > 1) {
                    for (i = 0; i < data.sameday_cities.length; i++) {
                        if ({{ locker_city_id }} == data.sameday_cities[i]['locker_city_id']){
                            var locker_city_checked = 'checked=""';
                        } else {
                            var locker_city_checked = '';
                        }

                        html += '<div class="radio_elements"><label><input type="radio" name="tk_sameday_locker_city_id" value="' + data.sameday_cities[i]['locker_city_id'] + '" ' + locker_city_checked + ' data-name="' + data.sameday_cities[i]['locker_city'] + '" data-locker_postcode="' + data.sameday_cities[i]['locker_postcode'] + '" >' + data.sameday_cities[i]['locker_postcode'] + ' - ' + data.sameday_cities[i]['locker_city'] + '</label></div>';
                    }
                } else if (data.cities_count == 1) {
                    html += '<div class="radio_elements"><label><input type="radio" name="tk_sameday_locker_city_id" value="' + data.sameday_cities[0]['locker_city_id'] + '" ' + locker_city_checked + ' data-name="' + data.sameday_cities[0]['locker_city'] + '" data-locker_postcode="' + data.sameday_cities[0]['locker_postcode'] + '" >' + data.sameday_cities[0]['locker_postcode'] + ' - ' + data.sameday_cities[0]['locker_city'] + '</label></div>';

                    $('#sameday_locker_city_id').val(data.sameday_cities[0]['locker_city_id']);
                    $('#sameday_locker_city').val(data.sameday_cities[0]['locker_city']);
                    $('#sameday_locker_city_select').val(data.sameday_cities[0]['locker_city']);
		                
                    $('#box_sameday_locker_city_select').addClass('tk_redy_box');
                    
                    getLockers();
                } else {
                    html += '{{ text_no_cities }}';
                }

                $('#sameday_locker_city_locator .radio_box').html(html);

                saveData();
            }
        });

        $('#tk_button_confirm').button('reset');
        $('.tk_all_spin').html('');
        $('#tk_checkout').css('opacity', '1');
        $('#tk_checkout').css('pointer-events', 'auto');
    }

    //извиква данните за офиси
    function getLockers() {
        var url = 'index.php?route=extension/shipping/tk_sameday/getLockers';

        var country_iso = $('#country_iso').val();
        url += '&country_iso=' + encodeURIComponent(country_iso);

        var locker_city_id = $('#sameday_locker_city_id').val();
        url += '&locker_city_id=' + encodeURIComponent(locker_city_id);

        $.ajax({
            url: url,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                if (data) {
                    //ако има повече от 1 офис изкаравме селектор, ако не слектираме автоматично
                    html = '';
                    
                    if (data.lockers_count > 1) {
                    
											{% if (sameday_locker_id) %}
                        var locker_id = {{ sameday_locker_id }};
											{% else %}
                        var locker_id = 0;
											{% endif %}

                        for (i = 0; i < data.sameday_lockers.length; i++) {
                            if (locker_id == data.sameday_lockers[i]['locker_id']) {
                                var locker_checked = 'checked=""';
                            } else {
                                var locker_checked = '';
                            }

                            html += '<div class="radio_elements"><label><input type="radio" name="tk_sameday_locker_locker_id" value="' + data.sameday_lockers[i]['locker_id'] + '" ' + locker_checked + ' data-name="' + data.sameday_lockers[i]['locker_name'] + '"  data-address="' + data.sameday_lockers[i]['locker_address'] + '"><span>' + data.sameday_lockers[i]['locker_id'] + '</span> <strong>' + data.sameday_lockers[i]['locker_name'] + '</strong><br> <i>' + data.sameday_lockers[i]['locker_address'] + '</i></label></div>';

                        }

                    } else {
                        html += '<div class="radio_elements"><label><input type="radio" name="tk_sameday_locker_locker_id" value="' + data.sameday_lockers[0]['locker_id'] + '" checked="" data-name="' + data.sameday_lockers[0]['locker_name'] + '"  data-address="' + data.sameday_lockers[0]['locker_address'] + '"><span>' + data.sameday_lockers[0]['locker_id'] + '</span> <strong>' + data.sameday_lockers[0]['locker_name'] + '</strong><br> <i>' + data.sameday_lockers[0]['locker_address'] + '</i></label></div>';

                        $('#sameday_locker_id').val(data.sameday_lockers[0]['locker_id']);
                        $('#sameday_locker_name').val(data.sameday_lockers[0]['locker_name']);
                        $('#sameday_locker_select').val(data.sameday_lockers[0]['locker_name']);
                        $('#sameday_locker_address').val(data.sameday_lockers[0]['locker_address']);

                        $('#box_sameday_locker_select').addClass('tk_redy_box');

                    }

                    $('#sameday_locker_locator .radio_box').html(html);
                }

                $("#sameday_locker_select").prop('disabled', false);
		            
                $('#box_sameday_locker_city_select').addClass('tk_redy_box');

                getShippingMethodAddress();

                saveData();
            }
        });

        $('#tk_button_confirm').button('reset');
        $('.tk_all_spin').html('');
        $('#tk_checkout').css('opacity', '1');
        $('#tk_checkout').css('pointer-events', 'auto');
    }

    //транслитерация за търсачката
    function transliterate(word) {
        return word.split('').map(function (char) {
            return Lat2Cyr[char] || char;
        }).join("");
    }

    Lat2Cyr = {
        "a": "а",
        "b": "б",
        "c": "ц",
        "d": "д",
        "e": "е",
        "f": "ф",
        "g": "г",
        "h": "х",
        "i": "и",
        "j": "ј",
        "k": "к",
        "l": "л",
        "m": "м",
        "n": "н",
        "o": "о",
        "p": "п",
        "q": "",
        "r": "р",
        "s": "с",
        "t": "т",
        "u": "у",
        "v": "в",
        "w": "",
        "x": "",
        "y": "",
        "z": "з",
        "A": "А",
        "B": "Б",
        "C": "Ц",
        "D": "Д",
        "E": "Е",
        "F": "Ф",
        "G": "Г",
        "H": "Х",
        "I": "И",
        "J": "Ј",
        "K": "К",
        "L": "Л",
        "M": "М",
        "N": "Н",
        "O": "О",
        "P": "П",
        "Q": "",
        "R": "Р",
        "S": "С",
        "T": "Т",
        "U": "У",
        "V": "В",
        "W": "",
        "X": "",
        "Y": "",
        "Z": "З",
        "č": "ч",
        "ć": "ћ",
        "đ": "ђ",
        "ž": "ж",
        "š": "ш",
        "Č": "Ч",
        "Ć": "Ћ",
        "Đ": "Ђ",
        "Ž": "Ж",
        "Š": "Ш"
    };

    //транслитерация за търсачката
    function transliterateEN(word) {
        return word.split('').map(function (char) {
            return getKeyByValue(Lat2Cyr, char) || char;
        }).join("");
    }

    function getKeyByValue(object, value) {
        return Object.keys(object).find(key => object[key] === value);
    }

</script>