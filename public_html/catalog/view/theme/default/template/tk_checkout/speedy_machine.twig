<div id="tk_speedy_machine">
	<div class="tk_panel">
		<div class="tk_panel_heading">
			<span class="tk_panel_icon"><span class="tk_icon-address"></span></span> 
			<span class="tk_panel_text"> {{ text_speedy_machine_title }}</span> 
			<span class="tk_all_spin"><i class="tk_icon-spin rotating"></i></span>
		</div>				
	
		<div class="tk_panel_body">
			<div id="tk_speedy_machines">

				<input type="hidden" id="shipping_to" name="shipping_to" value="machine" />
				<input type="hidden" id="shipping_type" name="shipping_type" value="speedy" />
				
				{% if module_tk_checkout_zone is not defined or module_tk_checkout_zone == 0 %} 
				<input type="hidden" id="zone_id" name="zone_id" value="{{ zone_id }}" />
				{% endif %} 

				{% if speedy_machines_customer %}
				<div class="tk_12_column tk_center_column">
					<label>
					<input type="radio" name="speedy_machine_type" value="existing" checked="checked" {% if (speedy_machine_type is defined and speedy_machine_type == 'existing') %}checked=""{% endif %} onclick="jQuery('#speedy_machine_new').hide();jQuery('#tk_speedy_machine_existing').show();" />
					
						{{ text_address_existing }}
					</label>
				</div>
				<div id="tk_speedy_machine_existing">
					<div class="tk_12_column tk_center_column">
						<select name="speedy_machine_customer_id">

							{% for speedy_machine_customer in speedy_machines_customer %} 
								
							<option value="{{ speedy_machine_customer['speedy_customer_id'] }}" {% if (speedy_machine_customer_id is defined and speedy_machine_customer['speedy_customer_id'] == speedy_machine_customer_id) %}selected="selected"{% endif %}>{{ speedy_machine_customer['office_name'] }}</option>
								
							{% endfor %} 
							
						</select>
					</div>
				</div>	 
				<div class="tk_12_column tk_center_column">
					<label>
					
						<input type="radio" name="speedy_machine_type" value="new" {% if (speedy_machine_type is defined and speedy_machine_type == 'new') %}checked=""{% endif %} onclick="jQuery('#speedy_machine_new').show();jQuery('#tk_speedy_machine_existing').hide();"/>
						{{ text_address_new }}
					</label>
				</div>
				
				 {% else %}
				<input type="hidden" name="speedy_machine_type" value="new">
				{% endif %} 

			
				<div id="speedy_machine_new" {% if (not speedy_machines_customer or (speedy_machine_type is defined and speedy_machine_type == 'new')) %} style="display:block"{% else %}style="display:none"{% endif %}>
					<div class="tk_6_column tk_center_column tk_speedy_machine_city_select tk_required_box {% if speedy_machine_city %} tk_redy_box{% endif %}" id="tk_speedy_machine_city_select">
					
						<input type="text" id="speedy_machine_city_select" readonly="true" name="speedy_machine_city_select" value="{{ speedy_machine_city }}" placeholder="{{ text_speedy_machine_city }}" />
						<span class="tk_floating_label">{{text_speedy_machine_city }}</span>
			
					</div>


					
					<div class="tk_6_column tk_center_column tk_speedy_machine_select tk_required_box {% if (((speedy_machines|length) < 1 or speedy_machine_id) and speedy_machine_city_id) %} tk_redy_box{% endif %}" id="tk_speedy_machine_id">
						<input type="text" id="speedy_machine_select" readonly="true" name="speedy_machine_select" value="{% if (speedy_machine_id) %}{{ speedy_machine_id ~ ' ' ~ speedy_machine_name }}{% endif %}" placeholder="{{ text_speedy_machine_title }}" {% if (not speedy_machine_city_id) %}disabled=""{% endif %} />
					<span class="tk_floating_label">{{text_speedy_machine_title }}</span>
					
						{% if error_machine and error_machine %}
						<span class="tk_text_error">{{ error_machine }}</span>
						{% endif %}
				
					</div>
					<div class="tk_clear"></div>
					<div class="tk_12_column tk_center_column ">
						<input type="hidden" id="speedy_machine_name" name="speedy_machine_name" value="{{ speedy_machine_name }}" />
						<input type="hidden" id="speedy_machine_address" name="speedy_machine_address" value="{{ speedy_machine_address }}" />
						<input type="hidden" id="speedy_machine_city" name="speedy_machine_city" value="{{ speedy_machine_city }}">
						<input type="hidden" id="speedy_machine_postcode" name="speedy_machine_postcode" value="{{ speedy_machine_postcode }}" />
						<input type="hidden" id="speedy_machine_city_id" name="speedy_machine_city_id" value="{{ speedy_machine_city_id }}">
						<input type="hidden" id="speedy_machine_id" name="speedy_machine_id" value="{{ speedy_machine_id }}">
					</div>
				</div>
				
				
				<div class="tk_clear"></div>
						
			</div>	
		</div>	
	</div>	
</div>

<div class="speedy_machine_city_container radio_container mfp-hide" id="speedy_machine_city_locator">
	<div class="radio_search">
		<input id="speedy_machine_city_search" name="speedy_machine_city_search" type="text" placeholder="Търсене.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for speedy_city in speedy_cities %}
		<div class="radio_elements">
			<label>
			
				<input type="radio" name="tk_speedy_machine_city_id" value="{{ speedy_city['city_id'] }}" {% if (speedy_machine_city_id is defined and speedy_city['city_id'] == speedy_machine_city_id) %}checked=""{% endif %} data-name="{{ speedy_city['name'] }}">{{ speedy_city['name'] }} 
			</label>
		</div>
		{% endfor %} 
	</div>
</div>

<div class="speedy_machine_container radio_container mfp-hide" id="speedy_machine_id_locator">
	<div class="radio_search">
		<input id="speedy_machine_search" name="speedy_machine_search" type="text" placeholder="Търсене.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for machine in speedy_machines %}
		<div class="radio_elements">
			<label>

				<input type="radio" name="tk_speedy_machine_id" value="{{ machine['office_id'] }}" {% if (speedy_machine_id is defined and machine['office_id'] == speedy_machine_id) %}checked=""{% endif %} data-name="{{ machine['office_id'] }} {{ machine['name'] }}">
				<span>{{ machine['office_id'] }}</span> <strong>{{ machine['name'] }}</strong> <br> <i>{{ machine['address'] }}</i>
			</label>
		</div>
		{% endfor %} 
	</div>
</div>

<script>
	
	$(document).ready(function() { 
		getPaymentMethod();
	});

	//попъп за градове
	$(document).on('click', '#speedy_machine_city_select', function(e) { 
			e.stopImmediatePropagation();
			$.magnificPopup.open( { 
					type: 'inline',
					items: { src: '#speedy_machine_city_locator' } 
				 } );
			setTimeout(function () { 
					$('#speedy_machine_city_search').focus();
				 } , 500);
		 } );
	 
	//въвеждане на град ръчно
	$("#speedy_machine_city_search").on("keyup", function(e) { 
			e.stopImmediatePropagation();
			var value = $(this).val().toLowerCase();
			var bg_value = transliterate(value);
			var en_value = transliterateEN(value);
			$("#speedy_machine_city_locator .radio_box .radio_elements").filter(function() { 
					$(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
				 } );
		 } );

	//добавяне на селектирания град и извеждаме офисите спрямо него
	$(document).delegate('#speedy_machine_city_locator .radio_box input[type=\'radio\']', 'click', function(e) { 
			e.stopImmediatePropagation();
			var speedy_machine_city_id = $(this).val();
			var speedy_machine_city = $(this).data('name');
			$('#speedy_machine_city_id').val(speedy_machine_city_id);
			$('#speedy_machine_city').val(speedy_machine_city);
			$('#speedy_machine_city_select').val(speedy_machine_city);
		
			$('.tk_all_spin').html(' <i class="tk_icon-spin rotating"></i>');
			$('#tk_checkout').css('opacity','0.6');
			$('#tk_checkout').css('pointer-events','none');
			$('#tk_button_confirm').prop('disabled', true);

      getMachinesByCityId();

			$.magnificPopup.close()

		 } );

	//попъп за офиси
	$(document).on('click', '#speedy_machine_select', function(e) { 
			e.stopImmediatePropagation();
			$.magnificPopup.open( { 
					type: 'inline',
					items: { src: '#speedy_machine_id_locator' } 
 
				 } );

			setTimeout(function () { 
					$('#speedy_machine_search').focus();
				 } , 500);
		 } );
	 
	//въвеждане на офис ръчно
	$("#speedy_machine_search").on("keyup", function(e) { 
			e.stopImmediatePropagation(); 
			var value = $(this).val().toLowerCase();
			var bg_value = transliterate(value);
			var en_value = transliterateEN(value);
			$("#speedy_machine_id_locator .radio_box .radio_elements").filter(function() { 
					$(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
				 } );
		 } );

	//добавяне на селектирания офис и извеждаме данните за него
	$(document).delegate('#speedy_machine_id_locator .radio_box input[type=\'radio\']', 'click', function(e) { 
			e.stopImmediatePropagation();
			var speedy_machine_id = $(this).val();
			var speedy_machine_name = $(this).data('name');
			$('#speedy_machine_id').val(speedy_machine_id);
			$('#speedy_machine_name').val(speedy_machine_name);
			$('#speedy_machine_select').val(speedy_machine_name);
	
			getMachine();

			$.magnificPopup.close()

		 } );
	 

	//извежда офисите спрямо града и извиква призчислени методи за доставка => извежда преизчислени тотали в количката
	//извиква данните за офиса ако е само 1
	function getMachinesByCityId() {
		$('.tk_speedy_machine_select').removeClass('tk_redy_box');
		
		$('#speedy_machine_id').val('');
		$('#speedy_machine_name').val('');
		$('#speedy_machine_select').val('');
		$('#speedy_machine_address').val('');
		$('#speedy_machine_city').val('');
		$('#speedy_machine_city_select').val('');
		$('#speedy_machine_postcode').val('');

		machine_city_id = $('#speedy_machine_city_id').val();

		$.ajax( { 
				url: 'index.php?route=extension/shipping/tk_speedy/getMachinesByCityId',
				type: 'POST',
				data: 'city_id=' + encodeURIComponent(machine_city_id),
				dataType: 'json',
				success: function(data) { 
					if (data) { 

						$('#speedy_machine_city').val(data.machine_city);
						$('#speedy_machine_city_select').val(data.machine_city);
						$('#speedy_machine_select').prop("disabled", false);
						
						//ако има повече от 1 офис изкаравме селектор, ако не слектираме автоматично
						if(data.machines_count > 1) { 
							html_popup = '';
								
						
							{% if (speedy_machine_id) %} 
								var machine_id = {{ speedy_machine_id }};
							{% else %} 
								var machine_id = 0;
							{% endif %} 
							
							
							for (i = 0; i < data.machines.length; i++) { 
								if(machine_id == data.machines[i]['office_id']) { 
									var machine_checked = 'checked=""';
								 } else { 
									var machine_checked = '';
								 } 
									 
								html_popup += '<div class="radio_elements"><label><input type="radio" name="tk_speedy_machine_id" value="' + data.machines[i]['office_id'] + '" ' + machine_checked + ' data-name="' + data.machines[i]['office_id'] + ' ' + data.machines[i]['name'] + '" ><span>' + data.machines[i]['office_id'] + '</span> <strong>' + data.machines[i]['name'] + '</strong><br> <i>' + data.machines[i]['address'] + '</i></label></div>';
								
							 } 
						
							$('.tk_speedy_machine_city_id').addClass('tk_redy_box');
							
							$('#speedy_machine_id_locator .radio_box').html(html_popup);
							$('#econt_machine_select').val('{{ text_speedy_machine_title }}');
		

						 } else { 
							html_popup = '';
								
							for (i = 0; i < 1; i++) { 
								html_popup += '<div class="radio_elements"><label><input type="radio" name="tk_speedy_machine_id" value="' + data.machines[i]['office_id'] + '" checked="" data-name="' + data.machines[i]['office_id'] + ' ' + data.machines[i]['name'] + '"><span>' + data.machines[i]['office_id'] + '</span> <strong>' + data.machines[i]['name'] + '</strong><br> <i>' + data.machines[i]['address'] + '</i></label></div>';
									
								speedy_machine_id = data.machines[i]['office_id'];
								speedy_machine_name = data.machines[i]['office_id'] + ' ' + data.machines[i]['name'];
							 } 
							 
							$('.tk_speedy_machine_select').addClass('tk_redy_box');
							$('.tk_speedy_machine_city_select').addClass('tk_redy_box');
								
							$('#speedy_machine_id_locator .radio_box').html(html_popup);
							$('#speedy_machine_id').val(speedy_machine_id);
							$('#speedy_machine_name').val(speedy_machine_name);
							$('#speedy_machine_select').val(speedy_machine_name);
	
							getMachine();
						 } 	
						 
						getShippingMethodAddress();
					 }
				 } 
			 } );
	 } 
	
	//извиква данните за офиса
	function getMachine() { 

		machine_id = $('#speedy_machine_id').val();

		$.ajax( { 
				url: 'index.php?route=extension/shipping/tk_speedy/getOffice',
				type: 'POST',
				data: 'office_id=' + encodeURIComponent(machine_id),
				dataType: 'json',
				success: function(data) { 
		
					if (data && data.name) { 
						$('#speedy_machine_name').val(data.name);
						$('#speedy_machine_select').val(data.office_id + ' ' + data.name);
						$('#speedy_machine_address').val(data.address);
						$('#speedy_machine_city').val(data.office_city);
						$('#speedy_machine_city_select').val(data.office_city);
						
						$('#speedy_machine_postcode').val(data.post_code);
						$('.tk_speedy_machine_select').addClass('tk_redy_box');
					 } 
					 
					 saveData();
				 } 
			 } );
	 } 
	
	//транслитерация за търсачката
	function transliterate(word) { 
		return word.split('').map(function (char) { 
				return Lat2Cyr[char] || char; 
			 } ).join("");
	 } 

	Lat2Cyr= { "a":"а","b":"б","c":"ц","d":"д","e":"е","f":"ф","g":"г","h":"х","i":"и","j":"ј","k":"к","l":"л","m":"м","n":"н","o":"о","p":"п","q":"","r":"р","s":"с","t":"т","u":"у","v":"в","w":"","x":"","y":"","z":"з","A":"А","B":"Б","C":"Ц","D":"Д","E":"Е","F":"Ф","G":"Г","H":"Х","I":"И","J":"Ј","K":"К","L":"Л","M":"М","N":"Н","O":"О","P":"П","Q":"","R":"Р","S":"С","T":"Т","U":"У","V":"В","W":"","X":"","Y":"","Z":"З","č":"ч","ć":"ћ","đ":"ђ","ž":"ж","š":"ш","Č":"Ч","Ć":"Ћ","Đ":"Ђ","Ž":"Ж","Š":"Ш" } ;
	
	//транслитерация за търсачката
	function transliterateEN(word) { 
		return word.split('').map(function (char) { 
				return getKeyByValue(Lat2Cyr,char) || char; 
			 } ).join("");
	 } 
	 
	function getKeyByValue(object, value) {
	  	return Object.keys(object).find(key => object[key] === value);
	}

</script>