<div id="tk_econt_office">
	<div class="tk_panel">
		<div class="tk_panel_heading">
			<span class="tk_panel_icon"><span class="tk_icon-address"></span></span> 
			<span class="tk_panel_text"> {{ text_econt_office_title }}</span> 
			<span class="tk_all_spin"><i class="tk_icon-spin rotating"></i></span>
								
			<div id="tk_econt_map" class="tk_right" {% if (not econt_offices or (econt_office_type is defined and econt_office_type == 'new')) %} style="display:inline-block"{% else %}style="display:none"{% endif %}><span class="tk_panel_text"> {{ text_econt_office_desc }} <a href="javascript:void(0);" id="econt_office_locator" style="color:red;">{{ text_econt_office_map }}</a></span> 			
			</div>
		</div>				
	
		<div class="tk_panel_body">
		
			<div id="tk_econt_offices">

				<input type="hidden" id="shipping_to" name="shipping_to" value="office" />
				<input type="hidden" id="shipping_type" name="shipping_type" value="econt" />
				
				{% if module_tk_checkout_zone is not defined or module_tk_checkout_zone == 0 %} 
				<input type="hidden" id="zone_id" name="zone_id" value="{{ zone_id }}" />
				{% endif %} 
		
			
				{% if (econt_offices_customer) %} 
				<div class="tk_12_column tk_center_column">
					<label>
						<input type="radio" name="econt_office_type" value="existing" checked="checked" {% if (econt_office_type is defined and econt_office_type == 'existing') %}checked=""{% endif %} onclick="jQuery('#econt_office_new').hide();jQuery('#tk_econt_office_existing').show();" />
						{{ text_address_existing }} 
					</label>
				</div>
				<div id="tk_econt_office_existing">
					<div class="tk_12_column tk_center_column">
						<select name="econt_office_customer_id">
							{% for econt_office_customer in econt_offices_customer %} 
								
							<option value="{{ econt_office_customer['econt_customer_id'] }}" {% if (econt_office_customer_id is defined and econt_office_customer['econt_customer_id'] == econt_office_customer_id) %}selected="selected"{% endif %}>{{ econt_office_customer['office_name'] }}</option>
								
							{% endfor %} 
						</select>
					</div>
				</div>	 
				<div class="tk_12_column tk_center_column">
					<label>
						<input type="radio" name="econt_office_type" value="new" {% if (econt_office_type is defined and econt_office_type == 'new') %}checked=""{% endif %} onclick="jQuery('#econt_office_new').show();jQuery('#tk_econt_office_existing').hide();jQuery('#tk_econt_map').show();"/>
						{{ text_address_new }} 
					</label>
				</div>
				
				{% else %} 
				<input type="hidden" name="econt_office_type" value="new">
				{% endif %} 

				<div id="econt_office_new" {% if (not econt_offices_customer or (econt_office_type is defined and econt_office_type == 'new')) %} style="display:block"{% else %}style="display:none"{% endif %}>
				
					<div class="tk_6_column tk_center_column tk_econt_office_city_select tk_required_box {% if (econt_office_city) %} tk_redy_box{% endif %}" id="tk_econt_office_city_select">
					
						<input type="text" id="econt_office_city_select" readonly="true" name="econt_office_city_select" value="{{ econt_office_city }}" placeholder="{{ text_econt_office_city }}" />
						<span class="tk_floating_label">{{ text_econt_office_city|replace({ ":": "" }) }}</span>
			
					</div>

					<div class="tk_6_column tk_center_column tk_econt_office_select tk_required_box {% if (((econt_offices|length) < 1 or econt_office_code) and econt_office_city_id) %} tk_redy_box{% endif %}" id="tk_econt_office_id">
			
						<input type="text" id="econt_office_select" readonly="true" name="econt_office_select" value="{% if (econt_office_code) %}{{ econt_office_code ~ ' ' ~ econt_office_name }}{% endif %}" placeholder="{{ text_econt_office_title }}" {% if (not econt_office_city_id) %}disabled=""{% endif %} />
						<span class="tk_floating_label">{{ text_econt_office_title|replace({ ":": "" }) }}</span>
					
					</div>
					<div class="tk_clear"></div>
					<div class="tk_12_column tk_center_column ">
						<input type="hidden" id="econt_office_code" name="econt_office_code" value="{{ econt_office_code }}" />
						<input type="hidden" id="econt_office_name" name="econt_office_name" value="{{ econt_office_name }}" />
						<input type="hidden" id="econt_office_address" name="econt_office_address" value="{{ econt_office_address }}" />
						<input type="hidden" id="econt_office_city" name="econt_office_city" value="{{ econt_office_city }}">
						<input type="hidden" id="econt_office_postcode" name="econt_office_postcode" value="{{ econt_office_postcode }}" />
						<input type="hidden" id="econt_office_city_id" name="econt_office_city_id" value="{{ econt_office_city_id }}">
						<input type="hidden" id="econt_office_id" name="econt_office_id" value="{{ econt_office_id }}">
					</div>
				</div>
				<div class="tk_clear"></div>		
			</div>
			
			{% if (econt_sms_enabled) %} 
			<div class="tk_12_column tk_center_column">
				<input type="checkbox" name="econt_sms" id="econt_sms" value="1" {% if (econt_sms and econt_sms == 2) %}checked=""{% endif %}>
				<label for="econt_sms"> {{ text_sms }}</label>
			</div>
			{% endif %} 
	
								
		</div>	
	</div>	
</div>

<div class="econt_office_city_container radio_container mfp-hide" id="econt_office_city_locator">
	<div class="radio_search">
		<input id="econt_office_city_search" name="econt_office_city_search" type="text" placeholder="Търсене.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for econt_city in econt_cities %} 
		<div class="radio_elements">
			<label>
				<input type="radio" name="tk_econt_office_city_id" value="{{ econt_city['city_id'] }}" {% if (econt_office_city_id is defined and econt_city['city_id'] == econt_office_city_id) %}checked=""{% endif %} data-name="{{ econt_city['name'] }}">{{ econt_city['name'] }} 
			</label>
		</div>
		{% endfor %} 
	</div>
</div>

<div class="econt_office_container radio_container mfp-hide" id="econt_office_id_locator">
	<div class="radio_search">
		<input id="econt_office_search" name="econt_office_search" type="text" placeholder="Търсене.." class="radio_box_search">
	</div>
	<div class="radio_box">
		{% for office in econt_offices %} 
		<div class="radio_elements">
			<label>
				<input type="radio" name="tk_econt_office_id" value="{{ office['office_id'] }}" {% if (econt_office_id is defined and office['office_id'] == econt_office_id) %}checked=""{% endif %} data-name="{{ office['office_code'] }} {{ office['name'] }}">
				<span>{{ office['office_code'] }}</span> <strong>{{ office['name'] }}</strong> <br> <i>{{ office['address'] }}</i>
			</label>
		</div>
		{% endfor %} 
	</div>
</div>

<script>

	$(document).ready(function() { 
		getPaymentMethod();
	});
		
	$(document).on('click', '#econt_sms', function(e) { 
		e.stopImmediatePropagation();
		$('.tk_all_spin').html(' <i class="tk_icon-spin rotating"></i>');
		$('#tk_checkout').css('opacity','0.6');
		$('#tk_checkout').css('pointer-events','none');
		$('#tk_button_confirm').prop('disabled', true);	
			
		getShippingMethodAddress();
			
	});
		
	//попъп за градове
	$(document).on('click', '#econt_office_city_select', function(e) { 
			e.stopImmediatePropagation();
			$.magnificPopup.open( { 
					type: 'inline',
					items: { src: '#econt_office_city_locator' } 
				 } );
			setTimeout(function () { 
					$('#econt_office_city_search').focus();
				 } , 200);
		 } );
	 
	//въвеждане на град ръчно
	$("#econt_office_city_search").on("keyup", function(e) { 
			e.stopImmediatePropagation();
			var value = $(this).val().toLowerCase();
			var bg_value = transliterate(value);
			var en_value = transliterateEN(value);
			$("#econt_office_city_locator .radio_box .radio_elements").filter(function() { 
					$(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
				 } );
		 } );

	//добавяне на селектирания град и извеждаме офисите спрямо него
	$(document).delegate('#econt_office_city_locator .radio_box input[type=\'radio\']', 'click', function(e) { 
			e.stopImmediatePropagation();
			var econt_office_city_id = $(this).val();
			var econt_office_city = $(this).data('name');
			$('#econt_office_city_id').val(econt_office_city_id);
			$('#econt_office_city').val(econt_office_city);
			$('#econt_office_city_select').val(econt_office_city);
		
			$('.tk_all_spin').html(' <i class="tk_icon-spin rotating"></i>');
			$('#tk_checkout').css('opacity','0.6');
			$('#tk_checkout').css('pointer-events','none');
			$('#tk_button_confirm').prop('disabled', true);	
			getOfficesByCityId();
			$.magnificPopup.close()

		 } );

	//попъп за офиси
	$(document).on('click', '#econt_office_select', function(e) { 
			e.stopImmediatePropagation();
			$.magnificPopup.open( { 
					type: 'inline',
					items: { src: '#econt_office_id_locator' } 
				 } );
			setTimeout(function () { 
					$('#econt_office_search').focus();
				 } , 500);
		 } );
	 
	//въвеждане на офис ръчно
	$("#econt_office_search").on("keyup", function(e) { 
			e.stopImmediatePropagation();
			var value = $(this).val().toLowerCase();
			var bg_value = transliterate(value);
			var en_value = transliterateEN(value);
			$("#econt_office_id_locator .radio_box .radio_elements").filter(function() { 
					$(this).toggle(($(this).text().toLowerCase().indexOf(value) > -1 || $(this).text().toLowerCase().indexOf(bg_value) > -1 || $(this).text().toLowerCase().indexOf(en_value) > -1));
				 } );
		 } );

	//добавяне на селектирания офис и извеждаме данните за него
	$(document).delegate('#econt_office_id_locator .radio_box input[type=\'radio\']', 'click', function(e) { 
			e.stopImmediatePropagation();
			var econt_office_id = $(this).val();
			var econt_office_name = $(this).data('name');
			$('#econt_office_id').val(econt_office_id);
			$('#econt_office_name').val(econt_office_name);
			$('#econt_office_select').val(econt_office_name);
			getOffice();
			saveData();
			$.magnificPopup.close()
		 } );

	/* избери офис от картата */
	function displayMessage(event) {
		if (event.data?.office === undefined) {
			return;
		} 
		getOfficeByOfficeCode(event.data.office.code);
		saveData();
		$.magnificPopup.close();
	}
	if (window.addEventListener) {
		window.addEventListener('message', displayMessage);
	} else {
		window.attachEvent("onmessage", displayMessage);
	}

	$('#econt_office_locator').magnificPopup( { 
			type: 'iframe',
			iframe: { 
				markup: '<div class="mfp-iframe-scaler econt_office_locator_mfp">'+
				'<div class="mfp-close"></div>'+
				'<iframe title="Econt Office Locator" allow="geolocation;" class="mfp-iframe" frameborder="0" allowfullscreen style="width: 100%; height: 90vh; border-width: 0px;"></iframe>'+
				'</div>',
				patterns: { 
					econtmaps: { 				 
						index: 'javascript:void(0);',					
						src: '{{ econt_office_locator }}&officeType=office&lang={{ lang }}&city=' + $('#econt_office_city').val()				
					} 
				}      
                    
			} 
		});
	/* избери офис от картата */
	
	//извежда офисите спрямо града и извиква призчислени методи за доставка => извежда преизчислени тотали в количката
	//извиква данните за офиса ако е само 1
	function getOfficesByCityId() { 
		$('.tk_econt_office_select').removeClass('tk_redy_box');
		
		$('#econt_office_id').val('');
		$('#econt_office_code').val('');
		$('#econt_office_name').val('');
		$('#econt_office_select').val('');
		$('#econt_office_address').val('');
		$('#econt_office_city').val('');
		$('#econt_office_city_select').val('');
		$('#econt_office_postcode').val('');

		office_city_id = $('#econt_office_city_id').val();

		$.ajax( { 
				url: 'index.php?route=extension/shipping/tk_econt/getOfficesByCityId',
				type: 'POST',
				data: 'city_id=' + encodeURIComponent(office_city_id),
				dataType: 'json',
				success: function(data) { 
					if (data) { 

						$('#econt_office_city').val(data.office_city);
						$('#econt_office_city_select').val(data.office_city);
						$('#econt_office_select').prop("disabled", false);
						
						//ако има повече от 1 офис изкаравме селектор, ако не слектираме автоматично
						if(data.offices_count > 1) { 
							html_popup = '';
							{% if (econt_office_id) %} 
							var office_id = {{ econt_office_id}};
							{% else %} 
							var office_id = 0;
							{% endif %} 
							
							for (i = 0; i < data.offices.length; i++) { 
								if(office_id == data.offices[i]['office_id']) { 
									var office_checked = 'checked=""';
								} else { 
									var office_checked = '';
								} 
									 
								html_popup += '<div class="radio_elements"><label><input type="radio" name="tk_econt_office_id" value="' + data.offices[i]['office_id'] + '" ' + office_checked + ' data-name="' + data.offices[i]['office_code'] + ' ' + data.offices[i]['name'] + '" ><span>' + data.offices[i]['office_code'] + '</span> <strong>' + data.offices[i]['name'] + '</strong><br> <i>' + data.offices[i]['address'] + '</i></label></div>';
								
							} 
						
							$('.tk_econt_office_city_id').addClass('tk_redy_box');
							$('#econt_office_id_locator .radio_box').html(html_popup);
							$('#econt_office_select').val('{{ text_econt_office_title }}');

						} else { 
							html_popup = '';
								
							for (i = 0; i < 1; i++) { 
								html_popup += '<div class="radio_elements"><label><input type="radio" name="tk_econt_office_id" value="' + data.offices[i]['office_id'] + '" checked="" data-name="' + data.offices[i]['office_code'] + ' ' + data.offices[i]['name'] + '"><span>' + data.offices[i]['office_code'] + '</span> <strong>' + data.offices[i]['name'] + '</strong><br> <i>' + data.offices[i]['address'] + '</i></label></div>';
									
								econt_office_id = data.offices[i]['office_id'];
								econt_office_name = data.offices[i]['office_code'] + ' ' + data.offices[i]['name'];
							} 
							 
							$('.tk_econt_office_select').addClass('tk_redy_box');
							$('.tk_econt_office_city_select').addClass('tk_redy_box');
								
							$('#econt_office_id_locator .radio_box').html(html_popup);
							$('#econt_office_id').val(econt_office_id);
							$('#econt_office_name').val(econt_office_name);
							$('#econt_office_select').val(econt_office_name);

							getOffice();
						 } 	
					 } 
					 
					 getShippingMethodAddress();
				} 
			});
	} 
	
	//извиква данните за офиса
	function getOffice() { 
		$('#econt_office_code').val('');
		office_id = $('#econt_office_id').val();
		$.ajax( { 
				url: 'index.php?route=extension/shipping/tk_econt/getOffice',
				type: 'POST',
				data: 'office_id=' + encodeURIComponent(office_id),
				dataType: 'json',
				success: function(data) { 
		
					if (data && data.office_code) { 
						$('#econt_office_code').val(data.office_code);
						$('#econt_office_name').val(data.name);
						$('#econt_office_select').val(data.office_code + ' ' + data.name);
						$('#econt_office_address').val(data.address);
						$('#econt_office_city').val(data.office_city);
						$('#econt_office_city_select').val(data.office_city);
						$('#econt_office_postcode').val(data.post_code);
						$('.tk_econt_office_select').addClass('tk_redy_box');
					} 
				} 
			});
	} 
	
	//извиква данните за офиса спярмо кода му, позлв се за селектора от картата
	function getOfficeByOfficeCode(office_code) { 
		if (parseInt(office_code)) { 
			$.ajax( { 
					url: 'index.php?route=extension/shipping/tk_econt/getOfficeByOfficeCode',
					type: 'POST',
					data: 'office_code=' + parseInt(office_code),
					dataType: 'json',
					success: function(data) { 
						if (!data.error) { 
							$('#econt_office_city_id').val(data.city_id);

							$('#econt_office_id').val(data.office_id);
							$('#econt_office_code').val(office_code);
							$('#econt_office_name').val(data.name);
							$('#econt_office_select').val(data.office_code + ' ' + data.name);
							$('#econt_office_address').val(data.address);
							$('#econt_office_city').val(data.office_city);
							$('#econt_office_city_select').val(data.office_city);
							$('#econt_office_postcode').val(data.post_code);
							$('.tk_econt_office_select').addClass('tk_redy_box');
						} 
					} 
				});
		} 
	} 
	
	//транслитерация за търсачката
	function transliterate(word) { 
		return word.split('').map(function (char) { 
				return Lat2Cyr[char] || char; 
			 } ).join("");
	 } 

	Lat2Cyr= { "a":"а","b":"б","c":"ц","d":"д","e":"е","f":"ф","g":"г","h":"х","i":"и","j":"ј","k":"к","l":"л","m":"м","n":"н","o":"о","p":"п","q":"","r":"р","s":"с","t":"т","u":"у","v":"в","w":"","x":"","y":"","z":"з","A":"А","B":"Б","C":"Ц","D":"Д","E":"Е","F":"Ф","G":"Г","H":"Х","I":"И","J":"Ј","K":"К","L":"Л","M":"М","N":"Н","O":"О","P":"П","Q":"","R":"Р","S":"С","T":"Т","U":"У","V":"В","W":"","X":"","Y":"","Z":"З","č":"ч","ć":"ћ","đ":"ђ","ž":"ж","š":"ш","Č":"Ч","Ć":"Ћ","Đ":"Ђ","Ž":"Ж","Š":"Ш" } ;
	
	//транслитерация за търсачката
	function transliterateEN(word) { 
		return word.split('').map(function (char) { 
				return getKeyByValue(Lat2Cyr,char) || char; 
			 } ).join("");
	 } 
	 
	function getKeyByValue(object, value) {
	  	return Object.keys(object).find(key => object[key] === value);
	}

</script>